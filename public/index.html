<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <meta name="description" content=""/>
    <meta name="author" content=""/>
    <title>Dashboard - SB Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css" rel="stylesheet"/>
    <link href="/src/css/styles.css" rel="stylesheet"/>
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <style>
        body {
          display: flex;
          margin: 0;
          font-family: sans-serif;
          height: 100vh;
          flex-direction: column;
        }
        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” ë†’ì´ ì œì™¸í•˜ê³  ì»¨í…ì¸  ë†’ì´ ì§€ì • */
        #dropZone {
  position: relative; /* ì¤‘ìš”: ìì‹ ìš”ì†Œì˜ absolute ê¸°ì¤€ì´ ë¨ */
  min-height: 500px;
  background-color: #fafafa;
  border: 2px dashed #90caf9;
  overflow: hidden; /* ì„ íƒ: ê·¸ë˜í”„ê°€ ì˜ì—­ì„ ë„˜ì§€ ì•Šê²Œ */
}
        #layoutSidenav_content {
          flex: 1;
          display: flex;
          flex-direction: column;
          overflow: hidden;
        }
        main {
          flex: 1;
          overflow: hidden;
        }
        .container-fluid {
          height: 100%;
          display: flex;
          flex-direction: column;
        }

        /* ì„¼ì„œëª©ë¡ + ê·¸ë˜í”„ ì˜ì—­ ë¶€ëª¨ ì»¨í…Œì´ë„ˆ */
        .dashboard-container {
          display: flex;
          gap: 10px;
          height: 650px; /* ë†’ì´ ì¡°ì ˆ ê°€ëŠ¥ */
          overflow: hidden;
        }

        .panel {
          width: 30%;
          padding: 10px;
          border-right: 1px solid #ccc;
          background: #f9f9f9;
          overflow-y: auto;
          box-sizing: border-box;
        }

        .graph-area {
          flex: 1;
          padding: 10px;
          background: #f4f4f4;
          overflow-y: auto;
          box-sizing: border-box;
          display: flex;
          flex-direction: column;
        }

        .drop-zone {
          border: 2px dashed #999;
          padding: 20px;
          flex: 1;
          background: white;
          overflow-y: auto;
          min-height: 200px;
        }

        .sensor-item {
          border: 1px solid #aaa;
          padding: 5px;
          margin-bottom: 8px;
          background: white;
        }

        .sensor-details {
          margin-top: 5px;
          background: #eee;
          padding: 5px;
        }

        .draggable {
          cursor: grab;
        }

        .graph-block {
          background: #fff;
          padding: 10px;
          margin-top: 20px;
          border: 1px solid #ccc;
        }
        .drag-handle {
  background-color: #f0f0f0;
  padding: 6px;
  cursor: move;
  user-select: none;
}
    </style>
</head>
<body class="sb-nav-fixed">
<nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
    <!-- Navbar Brand-->
    <a class="navbar-brand ps-3" href="/rocket-frontend/public/index.html">Start Bootstrap</a>
    <!-- Sidebar Toggle-->
    <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle" href="#!"><i
            class="fas fa-bars"></i></button>
    <!-- Navbar Search-->
    <form class="d-none d-md-inline-block form-inline ms-auto me-0 me-md-3 my-2 my-md-0">
        <div class="input-group">
            <input class="form-control" type="text" placeholder="Search for..." aria-label="Search for..."
                   aria-describedby="btnNavbarSearch"/>
            <button class="btn btn-primary" id="btnNavbarSearch" type="button"><i class="fas fa-search"></i></button>
        </div>
    </form>
    <!-- Navbar-->
    <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown"
               aria-expanded="false"><i class="fas fa-user fa-fw"></i></a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item" href="#!">Settings</a></li>
                <li><a class="dropdown-item" href="#!">Activity Log</a></li>
                <li>
                    <hr class="dropdown-divider"/>
                </li>
                <li><a class="dropdown-item" href="#!" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a></li>
            </ul>
        </li>
    </ul>
</nav>
<div id="layoutSidenav">
    <div id="layoutSidenav_nav">
        <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
            <div class="sb-sidenav-menu">
                <div class="nav">
                    <div class="sb-sidenav-menu-heading">Core</div>
                    <a class="nav-link" href="index.html">
                        <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                        Dashboard
                    </a>
                    <div class="sb-sidenav-menu-heading">Interface</div>
                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseLayouts"
                       aria-expanded="false" aria-controls="collapseLayouts">
                        <div class="sb-nav-link-icon"><i class="fas fa-columns"></i></div>
                        Layouts
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapseLayouts" aria-labelledby="headingOne"
                         data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">
                            <a class="nav-link" href="/rocket-frontend/public/history.html">History</a>
                            <a class="nav-link" href="/rocket-frontend/public/prediction.html">Prediction</a>
                        </nav>
                    </div>
                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapsePages"
                       aria-expanded="false" aria-controls="collapsePages">
                        <div class="sb-nav-link-icon"><i class="fas fa-book-open"></i></div>
                        Pages
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapsePages" aria-labelledby="headingTwo"
                         data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav accordion" id="sidenavAccordionPages">
                            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse"
                               data-bs-target="#pagesCollapseAuth" aria-expanded="false"
                               aria-controls="pagesCollapseAuth">
                                ì¸ì¦
                                <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                            </a>
                            <div class="collapse" id="pagesCollapseAuth" aria-labelledby="headingOne"
                                 data-bs-parent="#sidenavAccordionPages">
                                <nav class="sb-sidenav-menu-nested nav">
                                    <a class="nav-link" href="login.html">ë¡œê·¸ì¸</a>
                                    <a class="nav-link" href="findId.html">ì•„ì´ë””ì°¾ê¸°</a>
                                    <a class="nav-link" href="changePw.html">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</a>
                                </nav>
                            </div>
                        </nav>
                    </div>
                </div>
            </div>
            <div class="sb-sidenav-footer">
                <div class="small">Logged in as:</div>
                <span id="loggedInUser">User</span>
            </div>
        </nav>
    </div>
    <div id="layoutSidenav_content">
        <main>
            <div class="container-fluid px-4">
                <h1 class="mt-4">Dashboard</h1>
                <ol class="breadcrumb mb-4">
                    <li class="breadcrumb-item active">Dashboard</li>
                </ol>
                <div class="row">
                    <div class="col-xl-12">
                        <div class="card mb-4">
                            <div class="dashboard-container">
                                <div class="panel" id="sensorPanel">
                                    <h3>ì„¼ì„œ ëª©ë¡</h3>
                                    <!-- ì„¼ì„œ ëª©ë¡ ì—¬ê¸° ë Œë”ë§ -->
                                </div>

                                <div class="graph-area">
                                    <h3>ê·¸ë˜í”„ ì˜ì—­</h3>
                                    <div class="drop-zone" id="dropZone">
                                        ì„¼ì„œë¥¼ ë“œë˜ê·¸í•˜ì—¬ ê·¸ë˜í”„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer class="py-4 bg-light mt-auto">
            <div class="container-fluid px-4">
                <div class="d-flex align-items-center justify-content-between small">
                    <div class="text-muted">Copyright &copy; Your Website 2023</div>
                    <div>
                        <a href="#">Privacy Policy</a>
                        &middot;
                        <a href="#">Terms &amp; Conditions</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
<script src="/src/js/scripts.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js"
        crossorigin="anonymous"></script>
<script>
    const MAX_POINTS = 20;
    const FETCH_INTERVAL_MS = 1000;

    const sensors = [];
    const panel = document.getElementById('sensorPanel');
    const dropZone = document.getElementById('dropZone');

    const activeCharts = {};
    const sensorData = {};
    const fetchIntervals = {};
    const activeUpdates = {};
    const lastUpdateTimestamps = {};
    const restartCheckIntervals = {};

    let expandedSensorId = null;
    const token = localStorage.getItem('token');

async function authFetch(url, options = {}) {
  const token = localStorage.getItem('token');

  if (!token) {
    alert('ğŸ”’ ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
    window.location.href = '/rocket-frontend/public/login.html';
    return;
  }

  const fetchOptions = {
    ...options,
    headers: {
      ...options.headers,
      Authorization: `Bearer ${token}`,
    },
  };

  try {
    const response = await fetch(url, fetchOptions);

    if (response.status === 401) {
      alert('ğŸ”’ ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
      localStorage.removeItem('token'); // í† í° ì‚­ì œ
      window.location.href = '/rocket-frontend/public/login.html';
      return;
    }

    return response;
  } catch (error) {
    console.error('Fetch ì—ëŸ¬:', error);
    throw error;
  }
}

    // ------------- ì´ˆê¸°í™” -------------
    async function initialize() {
      await loadSensors();
      restoreSavedGraphs();
    }

    function logout() {
    localStorage.removeItem('token');  // ë˜ëŠ” sessionStorage.removeItem('token');
    window.location.href = '/rocket-frontend/public/login.html';
  }

async function saveGraphPositionToDB(dragId, left, top, width, height) {
  try {
    // ì„œë²„ê°€ ë°°ì—´ì„ ê¸°ëŒ€í•˜ë¯€ë¡œ ë°°ì—´ë¡œ ê°ì‹¸ì„œ ì „ì†¡
    const payload = [
      { dragId, left, top, width, height }
    ];

    const res = await authFetch(`http://localhost:8080/api/user/graph-layout-save`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error('ê·¸ë˜í”„ ìœ„ì¹˜ ì €ì¥ ì‹¤íŒ¨: ' + res.status);
    console.log(`Graph ${dragId} position saved`);
  } catch (err) {
    console.error(err);
  }
}

function makeChartResizable(container, canvas, chart) {
  // ResizeObserverë¥¼ í†µí•´ ìº”ë²„ìŠ¤ ì‚¬ì´ì¦ˆ ë³€ê²½ ê°ì§€
  const resizeObserver = new ResizeObserver(() => {
  const width = container.clientWidth;
  const height = container.clientHeight;

  canvas.width = width;
  canvas.height = height;

  chart.resize();

  // DB ì €ì¥
  const left = parseInt(container.style.left, 10) || 0;
  const top = parseInt(container.style.top, 10) || 0;
  saveGraphPositionToDB(container.dataset.dragId, left, top, width, height);
});

  resizeObserver.observe(container);
}

function makeGraphMovable(handleEl, targetEl) {
  let offsetX = 0;
  let offsetY = 0;
  let isDragging = false;

  handleEl.addEventListener('mousedown', (e) => {
    isDragging = true;

    const startLeft = parseInt(targetEl.style.left, 10) || 0;
    const startTop = parseInt(targetEl.style.top, 10) || 0;
    const parentRect = dropZone.getBoundingClientRect();

    offsetX = e.clientX - parentRect.left - startLeft;
    offsetY = e.clientY - parentRect.top - startTop;

    targetEl.style.zIndex = 1000;
    e.preventDefault();

    const onMouseMove = (e) => {
      if (!isDragging) return;
      let newLeft = e.clientX - parentRect.left - offsetX;
      let newTop = e.clientY - parentRect.top - offsetY;

      newLeft = Math.max(0, Math.min(parentRect.width - targetEl.offsetWidth, newLeft));
      newTop = Math.max(0, Math.min(parentRect.height - targetEl.offsetHeight, newTop));

      targetEl.style.left = `${newLeft}px`;
      targetEl.style.top = `${newTop}px`;
    };

    const onMouseUp = () => {
      if (!isDragging) return;
      isDragging = false;

      saveGraphPositionToDB(targetEl.dataset.dragId,
        parseInt(targetEl.style.left, 10),
        parseInt(targetEl.style.top, 10),
        targetEl.offsetWidth,
        targetEl.offsetHeight
      );

      targetEl.style.zIndex = ''; // ì›ë˜ëŒ€ë¡œ
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
    };

    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  });
}

function parseJwt(token) {
    if (!token) return null;
    const base64Payload = token.split('.')[1];
    const payload = atob(base64Payload.replace(/-/g, '+').replace(/_/g, '/'));
    return JSON.parse(payload);
  }

  // í˜ì´ì§€ ë¡œë“œì‹œ ì‹¤í–‰
  window.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('token');
    if (token) {
      const payload = parseJwt(token);
      if (payload && payload.sub) {
        document.getElementById('loggedInUser').textContent = payload.sub;
      }
    }
  });

if (token) {
  const payload = parseJwt(token);
  const userId = payload.sub; // JWTì—ì„œ ì‚¬ìš©ì idê°€ 'sub'ì— ì €ì¥ë˜ì–´ ìˆë‹¤ê³  ê°€ì •

  // HTMLì— ë„£ê¸°
  document.getElementById('loggedInUser').textContent = userId;
}

    // ------------- ì„¼ì„œ ëª©ë¡ ë¡œë”© -------------
   async function loadSensors() {
  try {
    const res = await authFetch('http://localhost:8080/api/sensors');

    if (!res.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ' + res.status);

    const data = await res.json();
    sensors.length = 0;
    data.forEach(item => sensors.push({
      deviceSerial: item.deviceSerial,
      sensorId: item.sensorId,
      sensorName: item.name,
      value: item.value,
      referenceValue: item.referenceValue,
      timestamp: item.timestamp,
    }));
    renderSensorList();
  } catch (err) {
    console.error('ì„¼ì„œ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', err);
    alert(err.message);
  }
}

    // ------------- ì„¼ì„œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ -------------
    function renderSensorList() {
      [...panel.children].forEach(child => {
        if (!child.matches('h3')) child.remove();
      });

      sensors.forEach(sensor => {
        const dragId = getDragId(sensor);
        const sensorDiv = createSensorItem(sensor, dragId);
        panel.appendChild(sensorDiv);
      });
    }

    // ì„¼ì„œ ì•„ì´í…œ DOM ìƒì„±
    function createSensorItem(sensor, dragId) {
      const div = document.createElement('div');
      div.className = 'sensor-item draggable';
      div.setAttribute('draggable', 'true');
      div.dataset.id = dragId;

      Object.assign(div.style, {
        cursor: 'pointer',
        padding: '10px',
        border: '1px solid #ccc',
        marginBottom: '8px',
        borderRadius: '5px',
        backgroundColor: 'white',
        transition: 'all 0.3s ease',
      });

      div.innerHTML = `<strong>${sensor.deviceSerial} - ${sensor.sensorName}</strong>`;

      div.addEventListener('dragstart', handleDragStart);
      div.addEventListener('click', () => toggleSensorExpansion(div, sensor, dragId));

      return div;
    }

    // ------------- ì„¼ì„œ ì•„ì´í…œ í™•ì¥/ì¶•ì†Œ í† ê¸€ -------------
    function toggleSensorExpansion(div, sensor, dragId) {
      if (expandedSensorId === dragId) {
        collapseSensorItem(div, dragId);
        expandedSensorId = null;
      } else {
        if (expandedSensorId) {
          const prev = panel.querySelector(`[data-id="${expandedSensorId}"]`);
          if (prev) collapseSensorItem(prev, expandedSensorId);
        }
        expandSensorItem(div, sensor, dragId);
        expandedSensorId = dragId;
      }
    }

    // í™•ì¥
    function expandSensorItem(div, sensor, dragId) {
      Object.assign(div.style, {
        flexBasis: '400px',
        backgroundColor: '#f0f8ff',
        position: 'relative',
      });

      // ê¸°ì¡´ ìº”ë²„ìŠ¤ ì œê±°
      const existingCanvas = div.querySelector('canvas');
      if (existingCanvas) existingCanvas.remove();

      const canvas = document.createElement('canvas');
      canvas.width = 380;
      canvas.height = 150;
      canvas.style.marginTop = '10px';
      div.appendChild(canvas);

      initChartAndFetch(sensor, dragId, canvas);
    }

    // ì¶•ì†Œ
    function collapseSensorItem(div, dragId) {
      Object.assign(div.style, {
        flexBasis: '',
        backgroundColor: 'white',
        position: '',
      });

      if (activeCharts[dragId]) {
        activeCharts[dragId].destroy();
        delete activeCharts[dragId];
      }
      delete sensorData[dragId];
      clearFetchInterval(dragId);

      const canvas = div.querySelector('canvas');
      if (canvas) canvas.remove();
    }

    // ------------- ì°¨íŠ¸ ì´ˆê¸°í™” ë° ë°ì´í„° fetch ì‹œì‘ -------------
    function initChartAndFetch(sensor, dragId, canvas) {
      if (!sensorData[dragId]) {
  sensorData[dragId] = { labels: [], values: [], referenceValues: [] };
}

      const ctx = canvas.getContext('2d');
      const color = getColor(Object.keys(activeCharts).length);

      const chart = new Chart(ctx, createChartConfig(sensor.sensorName, dragId, color));
      activeCharts[dragId] = chart;

      fetchIntervals[dragId] = setInterval(async () => {
  try {
    const res = await authFetch(`http://localhost:8080/api/sensors?sensorIds=${sensor.sensorId}`);
    if (!res.ok) throw new Error('ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨');

    const data = await res.json();
    if (!data || data.length === 0) {
      checkSensorTimeout(dragId, sensor);
      return;
    }

    const d = data[0];
    const now = Date.now();
    const last = lastUpdateTimestamps[dragId] || 0;

    // ë°ì´í„°ê°€ 1ì´ˆ ì´ë‚´ì¸ì§€ í™•ì¸
    const dataTimestamp = new Date(d.timestamp).getTime();
    if (Math.abs(now - dataTimestamp) <= 1000) {
      const timeStr = new Date(d.timestamp).toLocaleTimeString();
      updateChart(dragId, timeStr, [{
        name: d.name,
        value: d.value,
        referenceValue: d.referenceValue
      }]);
      lastUpdateTimestamps[dragId] = now;
    } else {
      checkSensorTimeout(dragId, sensor);
    }

  } catch (e) {
    console.error('ë°ì´í„° fetch ì¤‘ ì˜¤ë¥˜', e);
  }
}, FETCH_INTERVAL_MS);
}

    // ------------- ì°¨íŠ¸ ì„¤ì • ê°ì²´ ìƒì„± -------------
    function createChartConfig(sensorName, dragId, color) {
      return {
        type: 'line',
        data: {
          labels: sensorData[dragId].labels,
          datasets: [
            {
              label: sensorName,
              data: sensorData[dragId].values,
              borderColor: color,
              backgroundColor: color + '33',
              fill: false,
              tension: 0.1,
            },
            {
              label: `${sensorName} ê¸°ì¤€ê°’`,
              data: sensorData[dragId].referenceValues,
              borderColor: color,
              borderDash: [5, 5],
              pointRadius: 0,
              fill: false,
              tension: 0.1,
            }
          ]
        },
        options: {
          scales: {
            x: { type: 'category', title: { display: true, text: 'ì‹œê°„' } },
            y: { beginAtZero: true }
          },
          animation: false,
          plugins: { legend: { labels: { font: { size: 12 } } } }
        }
      };
    }

    // ------------- ì°¨íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸ -------------
    function updateChart(dragId, time, values) {
      const data = sensorData[dragId];
      data.labels.push(time);
      data.values.push(parseFloat(values[0].value));
      data.referenceValues.push(parseFloat(values[0].referenceValue));

      if (data.labels.length > MAX_POINTS) {
        data.labels.shift();
        data.values.shift();
        data.referenceValues.shift();
      }

      if (activeCharts[dragId]) activeCharts[dragId].update();
    }

    // ------------- fetchInterval í´ë¦¬ì–´ -------------
    function clearFetchInterval(dragId) {
      if (fetchIntervals[dragId]) {
        clearInterval(fetchIntervals[dragId]);
        delete fetchIntervals[dragId];
      }
    }

    // ------------- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ì²˜ë¦¬ -------------
    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.style.backgroundColor = '#e3f2fd';
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.style.backgroundColor = 'white';
    });

    dropZone.addEventListener('drop', handleDrop);

function handleDrop(e) {
  e.preventDefault();
  dropZone.style.backgroundColor = 'white';

  const dragId = e.dataTransfer.getData('text/plain');
  if (!dragId) return;

  if (activeCharts[dragId]) {
    alert('ì´ë¯¸ ì¶”ê°€ëœ ì„¼ì„œ ê·¸ë˜í”„ì…ë‹ˆë‹¤.');
    return;
  }

  const sensor = findSensorByDragId(dragId);
  if (!sensor) return;

  // ë§ˆìš°ìŠ¤ ì¢Œí‘œ ê³„ì‚° (dropZone ê¸°ì¤€)
  const rect = dropZone.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  addGraphToDropZone(sensor, dragId, x, y);
}

    // ------------- ë“œë˜ê·¸ ì‹œì‘ ì´ë²¤íŠ¸ -------------
    function handleDragStart(e) {
      e.dataTransfer.setData('text/plain', e.currentTarget.dataset.id);
    }

    // ------------- ë“œë¡­ì¡´ì— ê·¸ë˜í”„ ì¶”ê°€ -------------
function addGraphToDropZone(sensor, dragId, left = 0, top = 0) {
  const graphId = dragId.replace(/\|/g, '-');

  const graphBlock = document.createElement('div');
  graphBlock.className = 'graph-block';
  graphBlock.id = `graph-${graphId}`;

  Object.assign(graphBlock.style, {
    position: 'absolute',
    top: `${top}px`,
    left: `${left}px`,
    border: '1px solid #ccc',
    borderRadius: '5px',
    backgroundColor: 'white',
    resize: 'both',
    overflow: 'auto',
    width: '400px',
    height: '200px',
    zIndex: 10,
  });

  graphBlock.dataset.dragId = dragId;

  graphBlock.innerHTML = `
    <div class="drag-handle" style="cursor: move; background: #f7f7f7; padding: 5px; font-weight: bold;">
      ${sensor.deviceSerial} - ${sensor.sensorName}
      <button id="remove-${graphId}" style="float: right;">X</button>
    </div>
    <canvas id="chart-${graphId}" style="display: block;"></canvas>
  `;

  dropZone.appendChild(graphBlock);

  const canvas = document.getElementById(`chart-${graphId}`);
  const ctx = canvas.getContext('2d');

  sensorData[dragId] = { labels: [], values: [], referenceValues: [] };
  const color = getColor(Object.keys(activeCharts).length);
  const chart = new Chart(ctx, createChartConfig(sensor.sensorName, dragId, color));
  activeCharts[dragId] = chart;

  makeChartResizable(graphBlock, canvas, chart);
  makeGraphMovable(graphBlock.querySelector('.drag-handle'), graphBlock);

  document.getElementById(`remove-${graphId}`).addEventListener('click', () => {
    chart.destroy();
    delete activeCharts[dragId];
    delete activeUpdates[dragId];
    delete sensorData[dragId];
    clearFetchInterval(dragId);
    graphBlock.remove();
    saveActiveGraphs();
  });

  activeUpdates[dragId] = (time, values) => updateChart(dragId, time, values);

  fetchIntervals[dragId] = setInterval(async () => {
    try {
      const res = await authFetch(`http://localhost:8080/api/sensors?sensorIds=${sensor.sensorId}`);
      if (!res.ok) throw new Error('ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨');
      const data = await res.json();
      if (!data || data.length === 0) return;

      const d = data[0];
      const timeStr = new Date(d.timestamp).toLocaleTimeString();
      const values = [{ name: d.name, value: d.value, referenceValue: d.referenceValue }];

      if (d.value > d.referenceValue) {
  const emailSensor = {
    name: d.name,
    currentValue: d.value,
    threshold: d.referenceValue
  };
  triggerEmailAlert(emailSensor);
}

      activeUpdates[dragId]?.(timeStr, values);
    } catch (e) {
      console.error('ë°ì´í„° fetch ì¤‘ ì˜¤ë¥˜', e);
    }
  }, FETCH_INTERVAL_MS);

  saveActiveGraphs();

  return graphBlock; // âœ… ìœ„ì¹˜/í¬ê¸° ë³µì›ìš© ë°˜í™˜
}

    async function saveActiveGraphs() {
  const dragIds = Object.keys(activeCharts);
  try {
    await authFetch('http://localhost:8080/api/user/graph-layout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ activeGraphs: dragIds }),
    });
    console.log('ğŸ§  ê·¸ë˜í”„ ìƒíƒœ ì„œë²„ì— ì €ì¥ ì™„ë£Œ');
  } catch (e) {
    console.error('âš ï¸ ê·¸ë˜í”„ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:', e);
  }
}

async function restoreSavedGraphs() {
  try {
    // 1ï¸âƒ£ ì €ì¥ëœ í™œì„± ê·¸ë˜í”„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    const res = await authFetch('http://localhost:8080/api/user/graph-layout');
    if (!res.ok) throw new Error('ê·¸ë˜í”„ ë ˆì´ì•„ì›ƒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
    const data = await res.json();
    const savedGraphIds = data.activeGraphs || [];

    // 2ï¸âƒ£ ê·¸ë˜í”„ ìœ„ì¹˜/í¬ê¸° ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    const layoutRes = await authFetch('http://localhost:8080/api/user/graph-layout-save');
    if (!layoutRes.ok) throw new Error('ê·¸ë˜í”„ ë ˆì´ì•„ì›ƒ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
    const layouts = await layoutRes.json();

    console.log('ğŸ§  ë³µì› ëŒ€ìƒ ê·¸ë˜í”„:', savedGraphIds);
    console.log('ğŸ“ ì €ì¥ëœ ë ˆì´ì•„ì›ƒ:', layouts);

    // 3ï¸âƒ£ ê° ê·¸ë˜í”„ ë³µì›
    savedGraphIds.forEach(dragId => {
      const sensor = findSensorByDragId(dragId);
      if (!sensor) {
        console.warn(`âš ï¸ ì„¼ì„œ(${dragId})ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        return;
      }

      // í•´ë‹¹ ê·¸ë˜í”„ì˜ ì €ì¥ëœ ìœ„ì¹˜/í¬ê¸° ì°¾ê¸°
      const layout = layouts.find(l => l.dragId === dragId);
      const left = layout?.posLeft ?? 0;
      const top = layout?.posTop ?? 0;
      const width = layout?.width ?? 400;
      const height = layout?.height ?? 200;

      // ê·¸ë˜í”„ ìƒì„± ë° ë°˜í™˜
      const graphBlock = addGraphToDropZone(sensor, dragId, left, top);

      // ìœ„ì¹˜ì™€ í¬ê¸° ì ìš©
      if (graphBlock) {
        graphBlock.style.left = `${left}px`;
        graphBlock.style.top = `${top}px`;
        graphBlock.style.width = `${width}px`;
        graphBlock.style.height = `${height}px`;
      }
    });

    console.log('âœ… ê·¸ë˜í”„ ë³µì› ì™„ë£Œ');
  } catch (e) {
    console.error('âš ï¸ ê·¸ë˜í”„ ìƒíƒœ ë³µì› ì‹¤íŒ¨:', e);
  }
}

    // ------------- ìœ í‹¸ -------------
    function getDragId(sensor) {
      return `${sensor.deviceSerial}|${sensor.sensorId}|${sensor.sensorName}`;
    }

    function findSensorByDragId(dragId) {
      return sensors.find(s => getDragId(s) === dragId);
    }

    function getColor(index) {
      const colors = [
        '#ff6384', '#36a2eb', '#cc65fe', '#ffce56',
        '#2ecc71', '#e67e22', '#3498db', '#9b59b6'
      ];
      return colors[index % colors.length];
    }

    function checkSensorTimeout(dragId, sensor) {
  const now = Date.now();
  const last = lastUpdateTimestamps[dragId] || 0;

  if (now - last > 1000 && fetchIntervals[dragId]) {
    clearFetchInterval(dragId);
    console.warn(`ì„¼ì„œ ${dragId} ë°ì´í„° ì—†ìŒ. ì—…ë°ì´íŠ¸ ì¤‘ë‹¨.`);

    // ìë™ ì¬ì‹œì‘ ê°ì‹œ ì‹œì‘ (3ì´ˆ ê°„ê²©)
    if (!restartCheckIntervals[dragId]) {
      restartCheckIntervals[dragId] = setInterval(() => {
        tryRestartSensorFetch(dragId, sensor);
      }, 3000);
    }
  }
}

async function tryRestartSensorFetch(dragId, sensor) {
  try {
    const res = await authFetch(`http://localhost:8080/api/sensors?sensorIds=${sensor.sensorId}`);
    if (!res.ok) throw new Error('ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨');

    const data = await res.json();
    if (!data || data.length === 0) return;

    const d = data[0];
    const now = Date.now();
    const dataTimestamp = new Date(d.timestamp).getTime();

    if (Math.abs(now - dataTimestamp) <= 1000) {
      console.info(`ì„¼ì„œ ${dragId} ë°ì´í„° ì¬ìˆ˜ì‹ . ì—…ë°ì´íŠ¸ ì¬ê°œ.`);

      // ìƒíƒœ ì´ˆê¸°í™”
      lastUpdateTimestamps[dragId] = now;

      // ê°ì‹œ ì¤‘ë‹¨
      clearInterval(restartCheckIntervals[dragId]);
      delete restartCheckIntervals[dragId];

      // fetch ì¬ì‹œì‘
      restartSensorFetch(dragId, sensor);
    }
  } catch (e) {
    console.error('ìë™ ì¬ì‹œì‘ fetch ì‹¤íŒ¨:', e);
  }
}

// ---------------- ì´ë©”ì¼ ì•Œë¦¼ ----------------
async function triggerEmailAlert(sensor) {
  try {
    if (!sensor || !sensor.name) {
      console.warn('âš ï¸ ì„¼ì„œ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:', sensor);
      return;
    }

    // ì„œë²„ì—ì„œ ìœ ì—°í•˜ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ JSON êµ¬ì¡° ê·¸ëŒ€ë¡œ ì „ë‹¬
    const payload = {
      name: sensor.name,
      currentValue: sensor.currentValue,
      threshold: sensor.threshold
    };

    const res = await authFetch('http://localhost:8080/api/alert/email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    if (!res) return;
    if (!res.ok) throw new Error(res.status);

    console.log(`âš ï¸ ì´ë©”ì¼ ì•Œë¦¼ ì „ì†¡: ${sensor.name}`);
  } catch (e) {
    console.error('ì´ë©”ì¼ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨', e);
  }
}

function restartSensorFetch(dragId, sensor) {
  fetchIntervals[dragId] = setInterval(async () => {
  try {
    const res = await authFetch(`http://localhost:8080/api/sensors?sensorIds=${sensor.sensorId}`);
    if (!res.ok) throw new Error('ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨');
    const data = await res.json();
    if (!data || data.length === 0) return;

    const d = data[0];
    const timeStr = new Date(d.timestamp).toLocaleTimeString();
    const values = [{ name: d.name, value: d.value, referenceValue: d.referenceValue }];

    activeUpdates[dragId]?.(timeStr, values);
  } catch (e) {
    console.error('ë°ì´í„° fetch ì¤‘ ì˜¤ë¥˜', e);
  }
}, FETCH_INTERVAL_MS);
}

    // ------------- ì‹œì‘ -------------
    initialize();
</script>
</body>
</html>
