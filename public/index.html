<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Dashboard - SB Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css" rel="stylesheet" />
    <link href="/src/css/styles.css" rel="stylesheet" />
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <style>
        body {
          display: flex;
          margin: 0;
          font-family: sans-serif;
          height: 100vh;
          flex-direction: column;
        }
        /* 상단 네비게이션 바 높이 제외하고 컨텐츠 높이 지정 */
        #layoutSidenav_content {
          flex: 1;
          display: flex;
          flex-direction: column;
          overflow: hidden;
        }
        main {
          flex: 1;
          overflow: hidden;
        }
        .container-fluid {
          height: 100%;
          display: flex;
          flex-direction: column;
        }

        /* 센서목록 + 그래프 영역 부모 컨테이너 */
        .dashboard-container {
          display: flex;
          gap: 10px;
          height: 400px; /* 높이 조절 가능 */
          overflow: hidden;
        }

        .panel {
          width: 30%;
          padding: 10px;
          border-right: 1px solid #ccc;
          background: #f9f9f9;
          overflow-y: auto;
          box-sizing: border-box;
        }

        .graph-area {
          flex: 1;
          padding: 10px;
          background: #f4f4f4;
          overflow-y: auto;
          box-sizing: border-box;
          display: flex;
          flex-direction: column;
        }

        .drop-zone {
          border: 2px dashed #999;
          padding: 20px;
          flex: 1;
          background: white;
          overflow-y: auto;
          min-height: 200px;
        }

        .sensor-item {
          border: 1px solid #aaa;
          padding: 5px;
          margin-bottom: 8px;
          background: white;
        }

        .sensor-details {
          margin-top: 5px;
          background: #eee;
          padding: 5px;
        }

        .draggable {
          cursor: grab;
        }

        .graph-block {
          background: #fff;
          padding: 10px;
          margin-top: 20px;
          border: 1px solid #ccc;
        }
    </style>
</head>
<body class="sb-nav-fixed">
<nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
    <!-- Navbar Brand-->
    <a class="navbar-brand ps-3" href="/index.html">Start Bootstrap</a>
    <!-- Sidebar Toggle-->
    <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle" href="#!"><i class="fas fa-bars"></i></button>
    <!-- Navbar Search-->
    <form class="d-none d-md-inline-block form-inline ms-auto me-0 me-md-3 my-2 my-md-0">
        <div class="input-group">
            <input class="form-control" type="text" placeholder="Search for..." aria-label="Search for..." aria-describedby="btnNavbarSearch" />
            <button class="btn btn-primary" id="btnNavbarSearch" type="button"><i class="fas fa-search"></i></button>
        </div>
    </form>
    <!-- Navbar-->
    <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-user fa-fw"></i></a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item" href="#!">Settings</a></li>
                <li><a class="dropdown-item" href="#!">Activity Log</a></li>
                <li><hr class="dropdown-divider" /></li>
                <li><a class="dropdown-item" href="#!">Logout</a></li>
            </ul>
        </li>
    </ul>
</nav>
<div id="layoutSidenav">
    <div id="layoutSidenav_nav">
        <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
            <div class="sb-sidenav-menu">
                <div class="nav">
                    <div class="sb-sidenav-menu-heading">Core</div>
                    <a class="nav-link" href="index.html">
                        <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                        Dashboard
                    </a>
                    <div class="sb-sidenav-menu-heading">Interface</div>
                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseLayouts" aria-expanded="false" aria-controls="collapseLayouts">
                        <div class="sb-nav-link-icon"><i class="fas fa-columns"></i></div>
                        Layouts
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapseLayouts" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">
                            <a class="nav-link" href="#">Static Navigation</a>
                            <a class="nav-link" href="#">Light Sidenav</a>
                        </nav>
                    </div>
                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapsePages" aria-expanded="false" aria-controls="collapsePages">
                        <div class="sb-nav-link-icon"><i class="fas fa-book-open"></i></div>
                        Pages
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapsePages" aria-labelledby="headingTwo" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav accordion" id="sidenavAccordionPages">
                            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#pagesCollapseAuth" aria-expanded="false" aria-controls="pagesCollapseAuth">
                                Authentication
                                <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                            </a>
                            <div class="collapse" id="pagesCollapseAuth" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordionPages">
                                <nav class="sb-sidenav-menu-nested nav">
                                    <a class="nav-link" href="login.html">Login</a>
                                    <a class="nav-link" href="register.html">Register</a>
                                    <a class="nav-link" href="password.html">Forgot Password</a>
                                </nav>
                            </div>
                            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#pagesCollapseError" aria-expanded="false" aria-controls="pagesCollapseError">
                                Error
                                <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                            </a>
                            <div class="collapse" id="pagesCollapseError" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordionPages">
                                <nav class="sb-sidenav-menu-nested nav">
                                    <a class="nav-link" href="#">401 Page</a>
                                    <a class="nav-link" href="#">404 Page</a>
                                    <a class="nav-link" href="#">500 Page</a>
                                </nav>
                            </div>
                        </nav>
                    </div>
                    <div class="sb-sidenav-menu-heading">Addons</div>
                    <a class="nav-link" href="charts.html">
                        <div class="sb-nav-link-icon"><i class="fas fa-chart-area"></i></div>
                        Charts
                    </a>
                    <a class="nav-link" href="tables.html">
                        <div class="sb-nav-link-icon"><i class="fas fa-table"></i></div>
                        Tables
                    </a>
                </div>
            </div>
            <div class="sb-sidenav-footer">
                <div class="small">Logged in as:</div>
                Start Bootstrap
            </div>
        </nav>
    </div>
    <div id="layoutSidenav_content">
        <main>
            <div class="container-fluid px-4">
                <h1 class="mt-4">Dashboard</h1>
                <ol class="breadcrumb mb-4">
                    <li class="breadcrumb-item active">Dashboard</li>
                </ol>
                <div class="row">
                    <div class="col-xl-12">
                        <div class="card mb-4">
                            <div class="dashboard-container">
                                <div class="panel" id="sensorPanel">
                                    <h3>센서 목록</h3>
                                    <!-- 센서 목록 여기 렌더링 -->
                                </div>

                                <div class="graph-area">
                                    <h3>그래프 영역</h3>
                                    <div class="drop-zone" id="dropZone">
                                        센서를 드래그하여 그래프를 추가하세요
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer class="py-4 bg-light mt-auto">
            <div class="container-fluid px-4">
                <div class="d-flex align-items-center justify-content-between small">
                    <div class="text-muted">Copyright &copy; Your Website 2023</div>
                    <div>
                        <a href="#">Privacy Policy</a>
                        &middot;
                        <a href="#">Terms &amp; Conditions</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="/src/js/scripts.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js" crossorigin="anonymous"></script>
<script>
    const sensors = [];
    const panel = document.getElementById('sensorPanel');
    const dropZone = document.getElementById('dropZone');

    const activeCharts = {};
    const activeUpdates = {};
    const sensorData = {};
    const simulationIntervals = {};

    // 서버에서 센서 목록 가져오기
    async function fetchSensorsFromServer() {
        try {
            const response = await fetch('http://localhost:8080/api/sensors');
            if (!response.ok) throw new Error('서버 오류');

            const rawData = await response.json();  // SensorResponseDTO[]

            const groupedSensors = {};
            rawData.forEach(item => {
                const key = item.deviceSerial;

                if (!groupedSensors[key]) {
                    groupedSensors[key] = {
                        id: key,
                        name: `장치 ${key}`,
                        time: item.timestamp,
                        values: []
                    };
                }

                groupedSensors[key].values.push({
                    name: item.name,
                    value: item.value,
                    referenceValue: item.referenceValue
                });
            });

            sensors.length = 0;
            sensors.push(...Object.values(groupedSensors));

            renderSensorList();
        } catch (err) {
            console.error('센서 데이터를 가져오는 중 오류 발생:', err);
        }
    }

    // 센서 목록 렌더링
    function renderSensorList() {
        Array.from(panel.children).forEach(child => {
            if (!child.matches('h3')) child.remove();
        });

        sensors.forEach(sensor => {
            const sensorDiv = document.createElement('div');
            sensorDiv.className = 'sensor-item draggable';
            sensorDiv.setAttribute('draggable', 'true');
            sensorDiv.dataset.id = sensor.id;

            sensorDiv.innerHTML = `
                <strong>${sensor.name}</strong>
                <div class="sensor-details" style="display:none; margin-top: 5px;">
                    ${
                        Array.isArray(sensor.values)
                            ? sensor.values.map(val => `${val.name}: ${val.value} (기준: ${val.referenceValue})`).join('<br />')
                            : '센서 값 없음'
                    }
                    <br/>측정 시간: ${sensor.time}
                </div>
            `;

            sensorDiv.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', sensor.id);
            });

            sensorDiv.addEventListener('click', () => {
                const details = sensorDiv.querySelector('.sensor-details');
                details.style.display = details.style.display === 'block' ? 'none' : 'block';
            });

            panel.appendChild(sensorDiv);
        });
    }

    // 드롭존 이벤트
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.backgroundColor = '#e3f2fd';
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.style.backgroundColor = 'white';
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.backgroundColor = 'white';

        const sensorId = e.dataTransfer.getData('text/plain');
        if (!sensorId) return;

        if (activeCharts[sensorId]) {
            alert('이미 추가된 센서입니다.');
            return;
        }

        const sensor = sensors.find(s => s.id == sensorId);
        if (!sensor) return;

        const updateFunc = addGraph(sensor);
        activeUpdates[sensorId] = updateFunc;

        simulateSensorData(sensorId);
    });

    // 그래프 추가 함수
    function addGraph(sensor) {
        const sensorId = sensor.id;

        const graphBlock = document.createElement('div');
        graphBlock.className = 'graph-block';
        graphBlock.id = `graph-${sensorId}`;

        graphBlock.innerHTML = `
            <h4>${sensor.name}</h4>
            <canvas id="chart-${sensorId}" width="400" height="150"></canvas>
            <button id="remove-${sensorId}">그래프 제거</button>
        `;
        dropZone.appendChild(graphBlock);

        // 데이터 초기화
        sensorData[sensorId] = {
            labels: [],
            values: {}
        };

        sensor.values.forEach(val => {
            sensorData[sensorId].values[val.name] = [];
        });

        const ctx = document.getElementById(`chart-${sensorId}`).getContext('2d');

        // 데이터셋 생성 (값 + 기준값)
        const datasets = [];
        sensor.values.forEach((val, idx) => {
            const color = getColor(idx);

            // 실시간 값 라인
            datasets.push({
                label: `${val.name}`,
                data: sensorData[sensorId].values[val.name],
                borderColor: color,
                backgroundColor: color + '33',
                fill: false,
                tension: 0.1
            });

            // 기준값 라인 (고정 값 배열)
            datasets.push({
                label: `${val.name} 기준값`,
                data: [],
                borderColor: color,
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false,
                tension: 0.1
            });
        });

        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sensorData[sensorId].labels,
                datasets: datasets
            },
            options: {
                scales: {
                    x: {
                        type: 'category',
                        title: { display: true, text: '시간' }
                    },
                    y: { beginAtZero: true }
                }
            }
        });

        activeCharts[sensorId] = chart;

        // 데이터 업데이트 함수
        function updateChartData(time, values) {
            const data = sensorData[sensorId];
            data.labels.push(time);

            values.forEach(val => {
                if (!data.values[val.name]) data.values[val.name] = [];
                data.values[val.name].push(parseFloat(val.value));

                if (data.values[val.name].length > 20) {
                    data.values[val.name].shift();
                }

                // 기준값도 같이 shift
                const refDataset = chart.data.datasets.find(ds => ds.label === `${val.name} 기준값`);
                if (refDataset) {
                    refDataset.data.push(parseFloat(val.referenceValue));
                    if (refDataset.data.length > 20) refDataset.data.shift();
                }
            });

            if (data.labels.length > 20) {
                data.labels.shift();
            }

            chart.update();
        }

        // 제거 이벤트
        document.getElementById(`remove-${sensorId}`).addEventListener('click', () => {
            chart.destroy();
            delete activeCharts[sensorId];
            delete activeUpdates[sensorId];
            delete sensorData[sensorId];

            const graphBlock = document.getElementById(`graph-${sensorId}`);
            if (graphBlock) graphBlock.remove();

            stopSimulateSensorData(sensorId);
        });

        return updateChartData;
    }

    // 시뮬레이션 데이터 생성
    function simulateSensorData(sensorId) {
        if (simulationIntervals[sensorId]) return;

        simulationIntervals[sensorId] = setInterval(() => {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();

            const sensor = sensors.find(s => s.id == sensorId);
            if (!sensor) return;

            const values = sensor.values.map(val => {
                const fluctuation = (Math.random() - 0.5) * 5;
                const newValue = Math.max(0, (val.referenceValue || 50) + fluctuation);
                return {
                    name: val.name,
                    value: newValue.toFixed(1),
                    referenceValue: val.referenceValue
                };
            });

            if (activeUpdates[sensorId]) {
                activeUpdates[sensorId](timeStr, values);
            }
        }, 2000);
    }

    function stopSimulateSensorData(sensorId) {
        if (simulationIntervals[sensorId]) {
            clearInterval(simulationIntervals[sensorId]);
            delete simulationIntervals[sensorId];
        }
    }

    // 색상 매핑 함수
    function getColor(i) {
        const colors = [
            'rgba(255, 99, 132, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 159, 64, 1)'
        ];
        return colors[i % colors.length];
    }

    // 실행
    fetchSensorsFromServer();
</script>
</body>
</html>
